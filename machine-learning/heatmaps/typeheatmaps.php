<?php


$glaze_types = [
    '470' => ['470'],
    '480' => ['480'],
    '490' => ['490', '500', '510', '520', '530', '533', '535', '540', '550', '560', '570', '580', '585'],
    '500' => ['500', '510', '520', '530', '533'],
    '510' => ['510'],
    '520' => ['520'],
    '530' => ['530'],
    '533' => ['533'],
    '535' => ['535'],
    '540' => ['540'],
    '550' => ['550'],
    '560' => ['560'],
    '570' => ['570'],
    '580' => ['580'],
    '585' => ['585'],
    '590' => ['590', '600', '610', '620', '630'],
    '600' => ['600'],
    '610' => ['610'],
    '620' => ['620'],
    '630' => ['630'],
    '635' => ['635', '640', '650', '660', '670', '673', '675'],
    '640' => ['640', '650', '660', '670'],
    '650' => ['650'],
    '660' => ['660'],
    '670' => ['670'],
    '673' => ['673'],
    '675' => ['675'],
    '680' => ['680', '690', '700', '710', '720', '730', '740'],
    '690' => ['690'],
    '700' => ['700'],
    '710' => ['710'],
    '720' => ['720'],
    '730' => ['730'],
    '740' => ['740'],
    '745' => ['745'],
    '750' => ['750', '760', '770', '780', '790', '800', '810'],
    '760' => ['760'],
    '770' => ['770'],
    '780' => ['780'],
    '790' => ['790'],
    '800' => ['800'],
    '810' => ['810'],
    '820' => ['820', '830', '840', '850'],
    '830' => ['830'],
    '840' => ['840'],
    '850' => ['850'],
    '860' => ['860', '870'],
    '870' => ['870'],
    '880' => ['880', '890', '900', '910'],
    '890' => ['890'],
    '900' => ['900'],
    '910' => ['910'],
    '920' => ['920', '930', '940', '950', '960', '970'],
    '930' => ['930'],
    '940' => ['940'],
    '950' => ['950'],
    '960' => ['960'],
    '970' => ['970'],
    '980' => ['980', '990', '1000', '1010', '1020'],
    '990' => ['990'],
    '1000' => ['1000'],
    '1010' => ['1010'],
    '1020' => ['1020'],
    '1030' => ['1030'],
    '1040' => ['1040'],
    '1050' => ['1050'],
    '1055' => ['1055'],
    '1060' => ['1060', '1070', '1080', '1090'],
    '1070' => ['1070'],
    '1080' => ['1080'],
    '1090' => ['1090'],
    '1100' => ['1100'],
    '1110' => ['1110'],
    '1120' => ['1120'],
    '1130' => ['1130', '1140', '1150', '1155', '1160', '1170'],
    '1140' => ['1140'],
    '1150' => ['1150'],
    '1155' => ['1155'],
    '1160' => ['1160'],
    '1170' => ['1170'],
    '1180' => ['1180']
];


$cone_lookup = [
    1 => '022',
    2 => '021',
    3 => '020',
    4 => '019',
    5 => '018',
    6 => '017',
    7 => '016',
    8 => '015',
    9 => '014',
    10 => '013',
    11 => '012',
    12 => '011',
    13 => '010',
    14 => '09',
    15 => '08',
    16 => '07',
    17 => '06',
    18 => '05.5',
    19 => '05',
    20 => '04',
    21 => '03',
    22 => '02',
    23 => '01',
    24 => '1',
    25 => '2',
    26 => '3',
    27 => '4',
    28 => '5',
    29 => '5.5',
    30 => '6',
    31 => '7',
    32 => '8',
    33 => '9',
    34 => '10',
    35 => '11',
    36 => '12',
    37 => '13',
    38 => '14'
];

$heatmaps = [];
$all_types = [];

foreach ($glaze_types as $key => $type) {
    $type_id = strval($key);
    $heatmaps[$type_id] = [];
    for ($sio2 = 0; $sio2 <= 8; $sio2 += 0.1) {
        $sio2val = number_format(round($sio2*2)/2, 1);
        $heatmaps[$type_id][$sio2val] = [];
        $all_types[$sio2val] = [];
        for ($al2o3 = 0; $al2o3 <= 1; $al2o3 += 0.1) {
            $heatmaps[$type_id][$sio2val][number_format($al2o3, 1)] = '0';
            $all_types[$sio2val][number_format($al2o3, 1)] = '0';
        }
    }
}

// "material_type_id","ave_orton_cone_id","SiO2","Al2O3","B2O3","Li2O","K2O","Na2O","MgO","CaO","SrO","BaO","ZnO","PbO","P2O5","Cr2O3","MnO","MnO2","FeO","Fe2O3","CoO","NiO","CuO","Cu2O","TiO2","ZrO2","SnO2"

$umf_handle = fopen("../data/20210409_glaze_types_unique.csv", "r");
if (!$umf_handle) { return; }
while (($data = fgetcsv($umf_handle, 1000, ",")) !== FALSE) {
    // 'cone', 'SiO2', 'Al2O3', 'B2O3', 'R2O', 'RO'
    $type = strval($data[0]);
    $cone = strval($data[1]);
    $sio2 = number_format(round($data[2]*2)/2, 1);
    $al2o3 = number_format((float)$data[3], 1);
    // $sio2 = number_format(round($data[1]*2)/2, 1); // 0.0, 0.5, 1.0, etc.
    // $al2o3 = number_format($data[2], 1); // 0.1, 0.2, etc.
    // $b2o3 = $data[4];

    if ($type == '460') {
        // generic "Glaze" type
        if ($sio2 <= 8 && $al2o3 <= 1) {
            $all_types[$sio2][$al2o3] = $all_types[$sio2][$al2o3] + 1;
        }
    } else {
        $subtypes = $glaze_types[$type];

        if ($sio2 <= 8 && $al2o3 <= 1) {
            foreach($subtypes as $subtype) {
                if (!isset($heatmaps[$subtype])) { $heatmaps[$subtype] = []; }
                if (!isset($heatmaps[$subtype][$sio2])) { $heatmaps[$subtype][$sio2] = []; }
                if (!isset($heatmaps[$subtype][$sio2][$al2o3])) { $heatmaps[$subtype][$sio2][$al2o3] = 0; }
                $heatmaps[$subtype][$sio2][$al2o3] = $heatmaps[$subtype][$sio2][$al2o3] + 1;
            }
        }
        if ($sio2 <= 8 && $al2o3 <= 1) {
            if (!isset($all_types[$sio2][$al2o3])) { $all_types[$sio2][$al2o3] = 0; }
            $all_types[$sio2][$al2o3] = $all_types[$sio2][$al2o3] + 1;
        }
    }
}
fclose($umf_handle);

foreach ($glaze_types as $key => $type) {
    $type_id = strval($key);
    $fp = fopen('csv_types/'.$type_id.'.csv', 'w');
    for ($sio2 = 0; $sio2 <= 8; $sio2 += 0.1) {
        $sio2val = number_format(round($sio2*2)/2, 1);
        fputcsv($fp, array_merge([$sio2val], $heatmaps[$type_id][$sio2val]));
    }
    fclose($fp);
}

$fp = fopen('csv_types/all.csv', 'w');
for ($sio2 = 0; $sio2 <= 8; $sio2 += 0.1) {
    $sio2val = number_format(round($sio2*2)/2, 1);
    fputcsv($fp, array_merge([$sio2val], $all_types[$sio2val]));
}
fclose($fp);
